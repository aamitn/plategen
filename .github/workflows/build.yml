# Author: Bitmutex Technologies
name: Build and Release Plategen

on:
  push:
    branches:
      - main
      - master
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      # -------------------------------
      # 1. Checkout repository
      # -------------------------------
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Setup Python
      # -------------------------------
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -------------------------------
      # 3. Install dependencies
      # -------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------------------------------
      # 4. Build standalone executables
      # -------------------------------
      - name: ðŸ—ï¸ Build standalone executables
        run: |
          pyinstaller --clean --noconfirm --onefile --windowed --icon=plategen_icon.ico --name=plategen app.py --add-data "plategen_icon.ico;." --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=plategen_icon.ico --name=app_db app_db.py --add-data "plategen_icon.ico;." --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=plategen_icon.ico --name=app_ups app_ups.py --add-data "plategen_icon.ico;." --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=plategen_icon.ico --name=app_bch app_bch.py --add-data "plategen_icon.ico;." --collect-all requests
          
          mkdir dist_release
          
          copy dist\plategen.exe dist_release\
          copy dist\app_db.exe dist_release\
          copy dist\app_ups.exe dist_release\
          copy dist\app_bch.exe dist_release\
          copy appver.txt dist_release\
          
          # Create ZIP of dist_release contents
          powershell -Command "Compress-Archive -Path dist_release\* -DestinationPath dist_release.zip -Force"

      # -------------------------------
      # 5. Install Inno Setup
      # -------------------------------
      - name: ðŸ§° Install Inno Setup
        run: choco install innosetup --no-progress -y

      # -------------------------------
      # 6. Build installer (.exe) separately
      # -------------------------------
      - name: ðŸ“¦ Build installer (.exe)
        shell: cmd
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\iscript.iss"
          copy "installer\output\PlateGeneratorSetup.exe" "PlateGeneratorSetup.exe"

      # -------------------------------
      # 7. Determine release tag and name
      # -------------------------------
      - name: ðŸ§¾ Determine release tag and name
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="Snapshot"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Sticker Generator - $TAG" >> $GITHUB_OUTPUT

      # -------------------------------
      # 8. Create GitHub Release
      # -------------------------------
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.vars.outputs.tag == 'Snapshot' }}
          files: |
            dist_release.zip
            PlateGeneratorSetup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
