# Author: Bitmutex Technologies
name: Build and Release Plategen Workflow

on:
  push:
    tags:
      - 'v*'          # version tags like v1.0.0, v2.5.9
      - 'snapshot*'   # snapshot tags like snapshot-21-11-2025

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:

      # -------------------------------
      # 1. Checkout repository
      # -------------------------------
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Setup Python
      # -------------------------------
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -------------------------------
      # 3. Install dependencies
      # -------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------------------------------
      # 4. Build standalone executables
      # -------------------------------
      - name: ðŸ—ï¸ Build standalone executables
        run: |
          $DIST_DIR = "dist_release"

          # Build all EXEs
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/plategen_icon.ico --name=plategen app.py --add-data "installer/icons/plategen_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/plategen_icon.ico --name=app_db app_db.py --add-data "installer/icons/plategen_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/plategen_icon.ico --name=app_ups app_ups.py --add-data "installer/icons/plategen_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/plategen_icon.ico --name=app_bch app_bch.py --add-data "installer/icons/plategen_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/plategen_icon.ico --name=app_np app_np.py --add-data "installer/icons/plategen_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/plategen_icon.ico --name=app_np_db_schema app_np_db_schema.py --add-data "installer/icons/plategen_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/sticker_icon.ico --name=app_sticker app_sticker.py --add-data "installer/icons/sticker_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/manual_icon.ico --name=app_mgen_ups app_mgen_ups.py --add-data "installer/icons/manual_icon.ico;installer/icons" --collect-all requests
          pyinstaller --clean --noconfirm --onefile --windowed --icon=installer/icons/manual_icon.ico --name=app_mgen_bch app_mgen_bch.py --add-data "installer/icons/manual_icon.ico;installer/icons" --collect-all requests

          # Create dist directory
          mkdir $DIST_DIR

          # Copy all EXEs
          copy dist\*.exe $DIST_DIR\

          # Copy resources
          copy appver.txt $DIST_DIR\
          copy template-mgen-bch.docx $DIST_DIR\
          copy template-mgen-ups.docx $DIST_DIR\
          copy liveline_logo.dwg $DIST_DIR\
          copy sticker.png $DIST_DIR\
          copy db_export\nameplates.db $DIST_DIR\

      # -------------------------------
      # 5. Determine release tag and name
      # -------------------------------
      - name: ðŸ§¾ Determine release tag and name
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="Snapshot"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Plategen - $TAG" >> $GITHUB_OUTPUT

      # -------------------------------
      # 6. Create ZIP after tag detected
      # -------------------------------
      - name: ðŸ“¦ Create ZIP
        shell: pwsh
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          $DIST_DIR = "dist_release"
          $ZIP_FILE = "$DIST_DIR-$env:TAG.zip"
          Write-Host "Creating $ZIP_FILE"
          Compress-Archive -Path "$DIST_DIR\*" -DestinationPath "$ZIP_FILE" -Force

      # -------------------------------
      # 7. Install Inno Setup
      # -------------------------------
      - name: ðŸ§° Install Inno Setup
        run: choco install innosetup --no-progress -y

      # -------------------------------
      # 8. Build installer (.exe)
      # -------------------------------
      - name: ðŸ“¦ Build installer (.exe)
        shell: pwsh
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\iscript.iss"
          copy "installer\output\PlateGenSetup.exe" "PlateGenSetup-$env:TAG.exe"

      # -------------------------------
      # 9. Create GitHub Release
      # -------------------------------
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.vars.outputs.tag == 'Snapshot' }}
          files: |
            dist_release-${{ steps.vars.outputs.tag }}.zip
            PlateGenSetup-${{ steps.vars.outputs.tag }}.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
