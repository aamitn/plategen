# Author: Bitmutex Technologies
name: Build and Release Plategen Workflow

on:
  push:
    tags:
      - 'v*'          # version tags like v1.0.0, v2.5.9
      - 'snapshot*'   # snapshot tags like snapshot-21-11-2025

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:

      # -------------------------------
      # 1. Checkout repository
      # -------------------------------
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Setup Python
      # -------------------------------
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -------------------------------
      # 3. Install dependencies
      # -------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |


      # -------------------------------
      # 4. Build standalone executables
      # -------------------------------
      - name: ðŸ—ï¸ Build standalone executables
        run: |
          $DIST_DIR = "dist_release"


          # Create dist directory
          mkdir $DIST_DIR

          # Copy all EXEs
          # copy dist\*.exe $DIST_DIR\

          # Copy resources
          copy appver.txt $DIST_DIR\
          copy template-mgen-bch.docx $DIST_DIR\
          copy template-mgen-ups.docx $DIST_DIR\
          copy liveline_logo.dwg $DIST_DIR\
          copy sticker.png $DIST_DIR\
          copy db_export\nameplates.db $DIST_DIR\

      # -------------------------------
      # 5. Determine release tag and name
      # -------------------------------
      - name: ðŸ§¾ Determine release tag and name
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="Snapshot"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Plategen - $TAG" >> $GITHUB_OUTPUT

      # -------------------------------
      # 6. Create ZIP after tag detected
      # -------------------------------
      - name: ðŸ“¦ Create ZIP
        shell: pwsh
        # FIX: Directly interpolate the tag output into the PowerShell variable
        # instead of relying on the step-level 'env' block for safer interpolation.
        run: |
          $TAG = "${{ steps.vars.outputs.tag }}"
          $DIST_DIR = "dist_release"
          $ZIP_FILE = "$DIST_DIR-$TAG.zip"
          Write-Host "TAG detected: $TAG"
          Write-Host "Creating $ZIP_FILE"
          
          # Check if the directory exists before zipping
          if (-not (Test-Path -Path $DIST_DIR -PathType Container)) {
              Write-Error "Distribution directory '$DIST_DIR' not found."
              exit 1
          }

          Compress-Archive -Path "$DIST_DIR\*" -DestinationPath "$ZIP_FILE" -Force

      # -------------------------------
      # 7. Install Inno Setup
      # -------------------------------
      - name: ðŸ§° Install Inno Setup
        run: choco install innosetup --no-progress -y

      # -------------------------------
      # 8. Build installer (.exe)
      # -------------------------------
      - name: ðŸ“¦ Build installer (.exe)
        shell: pwsh
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          # The TAG environment variable is used here
          $TAG = $env:TAG
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\iscript.iss"

          # Also copy a version without the tag for easier reference/debugging if needed
          copy "installer\output\PlateGenSetup.exe" "PlateGenSetup.exe"

      # -------------------------------
      # 9. Create GitHub Release
      # -------------------------------
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.release_name }}
          draft: false
          # Snapshot tags are treated as prereleases
          prerelease: ${{ startsWith(steps.vars.outputs.tag, 'snapshot') }}
          files: |
            dist_release-${{ steps.vars.outputs.tag }}.zip
            PlateGenSetup.exe 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}